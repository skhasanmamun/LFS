<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin | Reports</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .mono { font-family: ui-monospace, Menlo, Monaco, Consolas, "Courier New", monospace; }
    .table-wrap { overflow-x: auto; }
    .badge-stat { font-size: .9rem; }
  </style>
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg bg-body-tertiary">
  <div class="container">
    <a class="navbar-brand" href="/dashboard.html">Lecture Feedback</a>
    <div class="d-flex">
      <a class="btn btn-outline-secondary btn-sm me-2" href="/dashboard.html">Dashboard</a>
      <button class="btn btn-outline-danger btn-sm" id="logoutBtn">Sign out</button>
    </div>
  </div>
</nav>

<div class="container py-4">
  <h4 class="mb-3">Admin Reports</h4>
  <div id="pageAlert" class="alert d-none" role="alert"></div>

  <div class="card shadow-sm mb-3">
    <div class="card-body row g-3 align-items-end">
      <div class="col-md-3">
        <label class="form-label">Search course</label>
        <input id="searchBox" class="form-control" placeholder="Code or title" />
      </div>
      <div class="col-md-3">
        <label class="form-label">From (UTC)</label>
        <input id="fromDate" type="datetime-local" class="form-control" />
      </div>
      <div class="col-md-3">
        <label class="form-label">To (UTC)</label>
        <input id="toDate" type="datetime-local" class="form-control" />
      </div>
      <div class="col-md-3 d-flex gap-2">
        <button id="applyFilters" class="btn btn-primary flex-grow-1">Apply</button>
        <button id="clearFilters" class="btn btn-outline-secondary">Clear</button>
      </div>
    </div>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="card-title">Course Averages</h5>
      <div class="table-wrap">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Code</th><th>Title</th><th>Credit</th><th>Count</th>
              <th>Clarity</th><th>Engagement</th><th>Pace</th><th>Overall</th><th></th>
            </tr>
          </thead>
          <tbody id="overviewBody"><tr><td colspan="9" class="text-center text-muted">No data</td></tr></tbody>
        </table>
      </div>
      <div class="d-flex justify-content-end gap-2">
        <button id="prevPage" class="btn btn-outline-secondary btn-sm">Prev</button>
        <button id="nextPage" class="btn btn-outline-secondary btn-sm">Next</button>
      </div>
    </div>
  </div>

  <div id="detailsCard" class="card shadow-sm d-none">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0" id="courseTitle">Course Details</h5>
        <button id="hideDetails" class="btn btn-outline-secondary btn-sm">Hide</button>
      </div>
      <div id="courseStats" class="mt-2 mb-3"></div>
      <div class="table-wrap">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Session ID</th><th>Start</th><th>End</th><th>Open</th>
              <th>Count</th><th>Clarity</th><th>Engagement</th><th>Pace</th><th>Overall</th><th></th>
            </tr>
          </thead>
          <tbody id="sessionsBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="fbModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Session Feedbacks</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="table-wrap">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>ID</th><th>When</th><th>Student</th><th>Clarity</th><th>Engagement</th><th>Pace</th><th>Comment</th>
              </tr>
            </thead>
            <tbody id="fbBody"><tr><td colspan="7" class="text-center text-muted">No data</td></tr></tbody>
          </table>
        </div>
        <div class="d-flex justify-content-end gap-2">
          <button id="fbPrev" class="btn btn-outline-secondary btn-sm">Prev</button>
          <button id="fbNext" class="btn btn-outline-secondary btn-sm">Next</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="/assets/js/common.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  (async function () {
    try { await auth.requireAuth(['Admin']); } catch { return; }
    document.getElementById('logoutBtn').addEventListener('click', auth.logout);

    const alertEl = document.getElementById('pageAlert');
    const showAlert = (m,t='info') => { alertEl.textContent=m; alertEl.className='alert alert-'+t; alertEl.classList.remove('d-none'); };
    const hideAlert = () => alertEl.classList.add('d-none');

    const overviewBody = document.getElementById('overviewBody');
    const sessionsBody = document.getElementById('sessionsBody');
    const detailsCard = document.getElementById('detailsCard');
    const courseTitle = document.getElementById('courseTitle');
    const courseStats = document.getElementById('courseStats');
    const hideDetails = document.getElementById('hideDetails');
    hideDetails.addEventListener('click', ()=>detailsCard.classList.add('d-none'));

    const searchBox = document.getElementById('searchBox');
    const fromDate = document.getElementById('fromDate');
    const toDate = document.getElementById('toDate');
    document.getElementById('applyFilters').addEventListener('click', ()=>{ page=1; loadOverview(); });
    document.getElementById('clearFilters').addEventListener('click', ()=>{
      searchBox.value=''; fromDate.value=''; toDate.value=''; page=1; loadOverview();
    });

    let page=1, pageSize=10, total=0, selectedCourseId=null;
    document.getElementById('prevPage').addEventListener('click', ()=>{ if(page>1){ page--; loadOverview(); }});
    document.getElementById('nextPage').addEventListener('click', ()=>{ if(page*pageSize<total){ page++; loadOverview(); }});

    function fmt(d){ return d? new Date(d).toLocaleString() : ''; }
    function badge(label,val,clr){ return `<span class="badge text-bg-${clr} badge-stat">${label}: ${val}</span>`; }
    function round2(n){ return Math.round((n + Number.EPSILON) * 100) / 100; }

    async function loadOverview(){
      hideAlert();
      overviewBody.innerHTML = `<tr><td colspan="9" class="text-center text-muted">Loading...</td></tr>`;
      const params = { page, pageSize };
      const s = searchBox.value.trim(); if(s) params.search=s;
      const f = fromDate.value ? new Date(fromDate.value).toISOString() : null;
      const t = toDate.value ? new Date(toDate.value).toISOString() : null;
      if (f) params.from=f; if (t) params.to=t;

      try {
        const res = await api.get('/api/admin/reports/overview', { params });
        total = res.data.total || 0;
        const items = res.data.items || [];
        if (!items.length) {
          overviewBody.innerHTML = `<tr><td colspan="9" class="text-center text-muted">No data</td></tr>`;
          return;
        }
        overviewBody.innerHTML = items.map(c=>{
          const o = round2(c.stats.avgOverall);
          return `<tr>
            <td class="mono">${c.code}</td>
            <td>${c.title}</td>
            <td>${c.credit}</td>
            <td>${c.stats.count}</td>
            <td>${round2(c.stats.avgClarity)}</td>
            <td>${round2(c.stats.avgEngagement)}</td>
            <td>${round2(c.stats.avgPace)}</td>
            <td><span class="badge text-bg-${o>=4?'success':o>=3?'warning':'secondary'}">${o}</span></td>
            <td><button class="btn btn-sm btn-outline-primary" data-action="detail" data-id="${c.courseId}">Details</button></td>
          </tr>`;
        }).join('');
      } catch { showAlert('Failed to load overview','danger'); }
    }

    overviewBody.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-action="detail"]'); if(!btn) return;
      const courseId = parseInt(btn.getAttribute('data-id'),10);
      await loadCourseDetail(courseId);
    });

    async function loadCourseDetail(courseId){
      selectedCourseId = courseId;
      const params = {};
      const f = fromDate.value ? new Date(fromDate.value).toISOString() : null;
      const t = toDate.value ? new Date(toDate.value).toISOString() : null;
      if (f) params.from=f; if (t) params.to=t;

      try {
        const res = await api.get(`/api/admin/reports/course/${courseId}`, { params });
        const c = res.data;
        detailsCard.classList.remove('d-none');
        courseTitle.textContent = `${c.code} â€” ${c.title}`;
        const o = round2(c.stats.avgOverall);
        courseStats.innerHTML = `
          ${badge('Count', c.stats.count,'primary')}
          ${badge('Overall', o, o>=4?'success':o>=3?'warning':'secondary')}
          ${badge('Clarity', round2(c.stats.avgClarity),'light')}
          ${badge('Engagement', round2(c.stats.avgEngagement),'light')}
          ${badge('Pace', round2(c.stats.avgPace),'light')}
        `;

        sessionsBody.innerHTML = c.sessions.map(s=>{
          const over = round2(s.stats.avgOverall);
          return `<tr>
            <td class="mono">${s.sessionId}</td>
            <td>${fmt(s.startTime)}</td>
            <td>${fmt(s.endTime) || '-'}</td>
            <td>${s.isOpen ? '<span class="badge text-bg-success">Open</span>' : '<span class="badge text-bg-secondary">Closed</span>'}</td>
            <td>${s.stats.count}</td>
            <td>${round2(s.stats.avgClarity)}</td>
            <td>${round2(s.stats.avgEngagement)}</td>
            <td>${round2(s.stats.avgPace)}</td>
            <td><span class="badge text-bg-${over>=4?'success':over>=3?'warning':'secondary'}">${over}</span></td>
            <td><button class="btn btn-sm btn-outline-secondary" data-action="fb" data-id="${s.sessionId}">View Feedbacks</button></td>
          </tr>`;
        }).join('');
      } catch { showAlert('Failed to load course details','danger'); }
    }

    const fbModal = new bootstrap.Modal(document.getElementById('fbModal'));
    const fbBody = document.getElementById('fbBody');
    let fbPage=1, fbPageSize=20, fbSessionId=null;

    sessionsBody.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-action="fb"]'); if(!btn) return;
      fbSessionId = parseInt(btn.getAttribute('data-id'),10);
      fbPage = 1;
      await loadFeedbacks();
      fbModal.show();
    });

    document.getElementById('fbPrev').addEventListener('click', ()=>{ if(fbPage>1){ fbPage--; loadFeedbacks(); }});
    document.getElementById('fbNext').addEventListener('click', ()=>{ fbPage++; loadFeedbacks(); });

    async function loadFeedbacks(){
      try {
        const res = await api.get(`/api/admin/reports/session/${fbSessionId}/feedbacks`, { params: { page: fbPage, pageSize: fbPageSize }});
        const items = res.data.items || [];
        if (!items.length) { fbBody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">No feedbacks</td></tr>`; return; }
        fbBody.innerHTML = items.map(f=>`
          <tr>
            <td class="mono">${f.feedbackId}</td>
            <td>${fmt(f.createdAt)}</td>
            <td>
              <div>${f.studentFullName || ''}</div>
              <div class="small mono text-muted">${f.studentEmail}</div>
              <div class="small text-muted">${f.rollNumber || ''}</div>
            </td>
            <td>${f.clarity}</td>
            <td>${f.engagement}</td>
            <td>${f.pace}</td>
            <td>${(f.comment||'').replace(/</g,'&lt;')}</td>
          </tr>
        `).join('');
      } catch { fbBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Failed to load</td></tr>`; }
    }

    await loadOverview();
  })();
</script>
</body>
</html>