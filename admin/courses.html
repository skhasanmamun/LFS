<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin | Courses</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .table-wrap { overflow-x: auto; }
    .pointer { cursor: pointer; }
  </style>
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg bg-body-tertiary">
  <div class="container">
    <a class="navbar-brand" href="/dashboard.html">Lecture Feedback</a>
    <div class="d-flex">
      <a class="btn btn-outline-secondary btn-sm me-2" href="/dashboard.html">Dashboard</a>
      <button class="btn btn-outline-danger btn-sm" id="logoutBtn">Sign out</button>
    </div>
  </div>
</nav>

<div class="container py-4">
  <h4 class="mb-3">Manage Courses</h4>

  <div id="pageAlert" class="alert d-none" role="alert"></div>

  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="card-title">Create New Course</h5>
      <form id="createCourseForm" class="row g-2 align-items-end">
        <div class="col-md-3">
          <label class="form-label">Code</label>
          <input id="code" class="form-control mono" placeholder="CS101" maxlength="16" required />
        </div>
        <div class="col-md-6">
          <label class="form-label">Title</label>
          <input id="title" class="form-control" placeholder="Intro to Computer Science" maxlength="200" required />
        </div>
        <div class="col-md-2">
          <label class="form-label">Credit</label>
          <input id="credit" type="number" class="form-control" value="3" min="1" max="10" />
        </div>
        <div class="col-md-1">
          <button class="btn btn-primary w-100" type="submit">Create</button>
        </div>
      </form>
    </div>
  </div>

  
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="row g-2 align-items-end mb-3">
        <div class="col-md-6">
          <label class="form-label">Search</label>
          <input id="searchBox" class="form-control" placeholder="By code or title (e.g., CS)" />
        </div>
        <div class="col-md-3">
          <button id="searchBtn" class="btn btn-outline-primary w-100">Search</button>
        </div>
        <div class="col-md-3">
          <button id="reloadBtn" class="btn btn-outline-secondary w-100">Reload</button>
        </div>
      </div>

      <div class="table-wrap">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>ID</th>
              <th>Code</th>
              <th>Title</th>
              <th>Credit</th>
              <th>Teachers</th>
              <th>Students</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="coursesBody">
            <tr><td colspan="7" class="text-center text-muted">No data</td></tr>
          </tbody>
        </table>
      </div>

      <div class="d-flex justify-content-between align-items-center">
        <div id="pagerInfo" class="text-muted small"></div>
        <div class="btn-group">
          <button id="prevPage" class="btn btn-outline-secondary btn-sm">Prev</button>
          <button id="nextPage" class="btn btn-outline-secondary btn-sm">Next</button>
        </div>
      </div>
    </div>
  </div>

  <div id="detailsCard" class="card shadow-sm d-none">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="card-title mb-0">Course Details</h5>
        <button id="closeDetails" class="btn btn-outline-secondary btn-sm">Hide</button>
      </div>
      <div id="courseInfo" class="mb-2 text-muted">Select a course to view details.</div>

      <div class="row">
        <div class="col-lg-6">
          <div class="d-flex justify-content-between align-items-center">
            <h6>Assigned Teachers</h6>
            <button id="addTeacherBtn" class="btn btn-sm btn-outline-primary">Add Teachers</button>
          </div>
          <ul id="teacherList" class="list-group list-group-flush"></ul>
        </div>
        <div class="col-lg-6">
          <div class="d-flex justify-content-between align-items-center">
            <h6>Assigned Students</h6>
            <button id="addStudentBtn" class="btn btn-sm btn-outline-primary">Add Students</button>
          </div>
          <ul id="studentList" class="list-group list-group-flush"></ul>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="addTeachersModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Assign Teachers</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="input-group mb-2">
          <input id="teacherSearch" class="form-control" placeholder="Search by name, email, employee ID" />
          <button id="teacherSearchBtn" class="btn btn-outline-primary">Search</button>
        </div>
        <div id="teachersResultsNote" class="small text-muted mb-2">Search to see results.</div>
        <div class="table-wrap">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th style="width:40px;"><input type="checkbox" id="checkAllTeachers" /></th>
                <th>Name</th>
                <th>Email</th>
                <th>Employee ID</th>
              </tr>
            </thead>
            <tbody id="teachersResults"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button id="assignTeachersBtn" class="btn btn-primary">Assign Selected</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="addStudentsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Assign Students</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="input-group mb-2">
          <input id="studentSearch" class="form-control" placeholder="Search by name, email, roll number" />
          <button id="studentSearchBtn" class="btn btn-outline-primary">Search</button>
        </div>
        <div id="studentsResultsNote" class="small text-muted mb-2">Search to see results.</div>
        <div class="table-wrap">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th style="width:40px;"><input type="checkbox" id="checkAllStudents" /></th>
                <th>Name</th>
                <th>Email</th>
                <th>Roll</th>
              </tr>
            </thead>
            <tbody id="studentsResults"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button id="assignStudentsBtn" class="btn btn-primary">Assign Selected</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="/assets/js/common.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  (async function() {
    try { await auth.requireAuth(['Admin']); } catch { return; }
    document.getElementById('logoutBtn').addEventListener('click', auth.logout);

    const pageAlert = document.getElementById('pageAlert');
    const form = document.getElementById('createCourseForm');
    const codeEl = document.getElementById('code');
    const titleEl = document.getElementById('title');
    const creditEl = document.getElementById('credit');
    const searchBox = document.getElementById('searchBox');
    const searchBtn = document.getElementById('searchBtn');
    const reloadBtn = document.getElementById('reloadBtn');
    const coursesBody = document.getElementById('coursesBody');
    const pagerInfo = document.getElementById('pagerInfo');
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');

    const detailsCard = document.getElementById('detailsCard');
    const closeDetails = document.getElementById('closeDetails');
    const courseInfo = document.getElementById('courseInfo');
    const teacherList = document.getElementById('teacherList');
    const studentList = document.getElementById('studentList');
    const addTeacherBtn = document.getElementById('addTeacherBtn');
    const addStudentBtn = document.getElementById('addStudentBtn');

    const addTeachersModal = new bootstrap.Modal(document.getElementById('addTeachersModal'));
    const addStudentsModal = new bootstrap.Modal(document.getElementById('addStudentsModal'));

    const teacherSearch = document.getElementById('teacherSearch');
    const teacherSearchBtn = document.getElementById('teacherSearchBtn');
    const teachersResults = document.getElementById('teachersResults');
    const teachersResultsNote = document.getElementById('teachersResultsNote');
    const checkAllTeachers = document.getElementById('checkAllTeachers');
    const assignTeachersBtn = document.getElementById('assignTeachersBtn');

    const studentSearch = document.getElementById('studentSearch');
    const studentSearchBtn = document.getElementById('studentSearchBtn');
    const studentsResults = document.getElementById('studentsResults');
    const studentsResultsNote = document.getElementById('studentsResultsNote');
    const checkAllStudents = document.getElementById('checkAllStudents');
    const assignStudentsBtn = document.getElementById('assignStudentsBtn');

    // State
    let currentPage = 1;
    let pageSize = 10;
    let total = 0;
    let currentSearch = "";
    let selectedCourseId = null;

    function showAlert(msg, type = 'info') {
      pageAlert.textContent = msg;
      pageAlert.className = 'alert alert-' + type;
      pageAlert.classList.remove('d-none');
    }
    function hideAlert() { pageAlert.classList.add('d-none'); }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideAlert();
      const payload = {
        code: codeEl.value.trim(),
        title: titleEl.value.trim(),
        credit: parseInt(creditEl.value, 10) || 3
      };
      if (!payload.code || !payload.title) return;

      try {
        await api.post('/api/admin/courses', payload);
        showAlert('Course created.', 'success');
        form.reset(); creditEl.value = 3;
        await loadCourses();
      } catch (err) {
        if (err?.response?.status === 409) showAlert('Course code already exists.', 'warning');
        else showAlert('Failed to create course.', 'danger');
      }
    });

    
    async function loadCourses() {
      const res = await api.get('/api/admin/courses', { params: { page: currentPage, pageSize, search: currentSearch || undefined } });
      const data = res.data;
      total = data.total || 0;
      const items = data.items || [];

      if (items.length === 0) {
        coursesBody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">No courses found</td></tr>`;
      } else {
        coursesBody.innerHTML = items.map(c => `
          <tr>
            <td>${c.id}</td>
            <td class="mono">${c.code}</td>
            <td>${c.title}</td>
            <td>${c.credit}</td>
            <td>${c.teacherCount}</td>
            <td>${c.studentCount}</td>
            <td><button class="btn btn-sm btn-outline-primary" data-action="manage" data-id="${c.id}">Manage</button></td>
          </tr>
        `).join('');
      }

      const start = (data.page - 1) * data.pageSize + 1;
      const end = Math.min(data.page * data.pageSize, total);
      pagerInfo.textContent = total ? `Showing ${start}-${end} of ${total}` : 'No results';
      prevPageBtn.disabled = data.page <= 1;
      nextPageBtn.disabled = end >= total;
    }

    prevPageBtn.addEventListener('click', async () => { if (currentPage > 1) { currentPage--; await loadCourses(); } });
    nextPageBtn.addEventListener('click', async () => {
      const maxPage = Math.ceil(total / pageSize);
      if (currentPage < maxPage) { currentPage++; await loadCourses(); }
    });

    searchBtn.addEventListener('click', async () => {
      currentSearch = searchBox.value.trim();
      currentPage = 1;
      await loadCourses();
    });
    reloadBtn.addEventListener('click', async () => {
      searchBox.value = ''; currentSearch = ''; currentPage = 1; await loadCourses();
    });

    coursesBody.addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-action="manage"]');
      if (!btn) return;
      const id = parseInt(btn.getAttribute('data-id'), 10);
      await loadCourseDetails(id);
    });

    async function loadCourseDetails(courseId) {
      hideAlert();
      selectedCourseId = courseId;
      detailsCard.classList.remove('d-none');
      courseInfo.textContent = 'Loading...';
      teacherList.innerHTML = '';
      studentList.innerHTML = '';

      try {
        const res = await api.get(`/api/admin/courses/${courseId}`);
        const c = res.data;

        courseInfo.innerHTML = `
          <div><b>${c.code}</b> — ${c.title} <span class="text-muted">[Credit: ${c.credit}]</span></div>
          <div class="small text-muted">Course ID: ${c.id}</div>
        `;

        if (!c.teachers || c.teachers.length === 0)
          teacherList.innerHTML = `<li class="list-group-item text-muted">No teachers assigned</li>`;
        else
          teacherList.innerHTML = c.teachers.map(t => `
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <div><b>${t.fullName || t.email}</b> <span class="text-muted small">#${t.id}</span></div>
                <div class="small text-muted">${t.email}${t.employeeId ? ' • ' + t.employeeId : ''}</div>
              </div>
              <button class="btn btn-sm btn-outline-danger" data-action="unassign-teacher" data-id="${t.id}">Remove</button>
            </li>
          `).join('');

        if (!c.students || c.students.length === 0)
          studentList.innerHTML = `<li class="list-group-item text-muted">No students assigned</li>`;
        else
          studentList.innerHTML = c.students.map(s => `
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <div><b>${s.fullName || s.email}</b> <span class="text-muted small">#${s.id}</span></div>
                <div class="small text-muted">${s.email}${s.rollNumber ? ' • ' + s.rollNumber : ''}</div>
              </div>
              <button class="btn btn-sm btn-outline-danger" data-action="unassign-student" data-id="${s.id}">Remove</button>
            </li>
          `).join('');
      } catch {
        courseInfo.textContent = 'Failed to load course.';
      }
    }

    closeDetails.addEventListener('click', () => detailsCard.classList.add('d-none'));

    teacherList.addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-action="unassign-teacher"]');
      if (!btn) return;
      const tid = parseInt(btn.getAttribute('data-id'), 10);
      if (!confirm('Remove this teacher from the course?')) return;
      try {
        await api.delete(`/api/admin/courses/${selectedCourseId}/teachers/${tid}`);
        await loadCourseDetails(selectedCourseId);
        showAlert('Teacher unassigned.', 'success');
        await loadCourses(); // refresh counts
      } catch {
        showAlert('Failed to unassign teacher.', 'danger');
      }
    });

    studentList.addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-action="unassign-student"]');
      if (!btn) return;
      const sid = parseInt(btn.getAttribute('data-id'), 10);
      if (!confirm('Remove this student from the course?')) return;
      try {
        await api.delete(`/api/admin/courses/${selectedCourseId}/students/${sid}`);
        await loadCourseDetails(selectedCourseId);
        showAlert('Student unassigned.', 'success');
        await loadCourses();
      } catch {
        showAlert('Failed to unassign student.', 'danger');
      }
    });

    addTeacherBtn.addEventListener('click', () => {
      teachersResults.innerHTML = '';
      teachersResultsNote.textContent = 'Search to see results.';
      checkAllTeachers.checked = false;
      addTeachersModal.show();
    });

    teacherSearchBtn.addEventListener('click', async () => {
      const q = teacherSearch.value.trim();
      const res = await api.get('/api/admin/teachers', { params: { q, page: 1, pageSize: 20 } });
      const items = res.data.items || [];
      teachersResultsNote.textContent = `Found ${res.data.total || items.length} (showing ${items.length})`;
      teachersResults.innerHTML = items.map(t => `
        <tr>
          <td><input type="checkbox" class="chk-teacher" value="${t.id}"></td>
          <td>${t.fullName || ''}</td>
          <td class="mono">${t.email}</td>
          <td>${t.employeeId || ''}</td>
        </tr>
      `).join('');
    });

    checkAllTeachers.addEventListener('change', () => {
      document.querySelectorAll('.chk-teacher').forEach(cb => cb.checked = checkAllTeachers.checked);
    });

    assignTeachersBtn.addEventListener('click', async () => {
      const ids = Array.from(document.querySelectorAll('.chk-teacher'))
        .filter(cb => cb.checked)
        .map(cb => parseInt(cb.value, 10));
      if (ids.length === 0) return;
      try {
        await api.post(`/api/admin/courses/${selectedCourseId}/assign-teachers`, { teacherIds: ids });
        addTeachersModal.hide();
        await loadCourseDetails(selectedCourseId);
        await loadCourses();
        showAlert('Teacher(s) assigned.', 'success');
      } catch {
        showAlert('Failed to assign teacher(s).', 'danger');
      }
    });

    addStudentBtn.addEventListener('click', () => {
      studentsResults.innerHTML = '';
      studentsResultsNote.textContent = 'Search to see results.';
      checkAllStudents.checked = false;
      addStudentsModal.show();
    });

    studentSearchBtn.addEventListener('click', async () => {
      const q = studentSearch.value.trim();
      const res = await api.get('/api/admin/students', { params: { q, page: 1, pageSize: 20 } });
      const items = res.data.items || [];
      studentsResultsNote.textContent = `Found ${res.data.total || items.length} (showing ${items.length})`;
      studentsResults.innerHTML = items.map(s => `
        <tr>
          <td><input type="checkbox" class="chk-student" value="${s.id}"></td>
          <td>${s.fullName || ''}</td>
          <td class="mono">${s.email}</td>
          <td>${s.rollNumber || ''}</td>
        </tr>
      `).join('');
    });

    checkAllStudents.addEventListener('change', () => {
      document.querySelectorAll('.chk-student').forEach(cb => cb.checked = checkAllStudents.checked);
    });

    assignStudentsBtn.addEventListener('click', async () => {
      const ids = Array.from(document.querySelectorAll('.chk-student'))
        .filter(cb => cb.checked)
        .map(cb => parseInt(cb.value, 10));
      if (ids.length === 0) return;
      try {
        await api.post(`/api/admin/courses/${selectedCourseId}/assign-students`, { studentIds: ids });
        addStudentsModal.hide();
        await loadCourseDetails(selectedCourseId);
        await loadCourses();
        showAlert('Student(s) assigned.', 'success');
      } catch {
        showAlert('Failed to assign student(s).', 'danger');
      }
    });

    await loadCourses();
  })();
</script>
</body>
</html>