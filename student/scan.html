<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Student | Scan & Submit Feedback</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    #reader { width: 320px; max-width: 100%; margin: 0 auto; }
    .stat-badge { font-size: 0.9rem; }
  </style>
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg bg-body-tertiary">
  <div class="container">
    <a class="navbar-brand" href="/dashboard.html">Lecture Feedback</a>
    <div class="d-flex">
      <a class="btn btn-outline-secondary btn-sm me-2" href="/dashboard.html">Dashboard</a>
      <button class="btn btn-outline-danger btn-sm" id="logoutBtn">Sign out</button>
    </div>
  </div>
</nav>

<div class="container py-4">
  <h4 class="mb-3">Scan QR & Submit Feedback</h4>

  <div id="globalAlert" class="alert d-none" role="alert"></div>

  <div class="row g-4">
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">QR Scanner</h5>
          <p class="text-muted mb-2">Allow camera access. Aim at the QR code. It will auto-detect the token.</p>

          <div class="d-flex gap-2 mb-3">
            <button id="startScanBtn" class="btn btn-primary btn-sm">Start Scanner</button>
            <button id="stopScanBtn" class="btn btn-outline-secondary btn-sm" disabled>Stop Scanner</button>
            <select id="cameraSelect" class="form-select form-select-sm" style="max-width: 260px;"></select>
          </div>

          <div id="reader" class="border rounded"></div>

          <hr class="my-3" />
          <h6>Or paste token manually</h6>
          <div class="input-group">
            <input id="manualToken" class="form-control" placeholder="Paste QR token here" />
            <button id="validateBtn" class="btn btn-outline-primary">Validate</button>
          </div>

          <div class="form-text mt-2">
            Tip: If the QR encodes a URL like .../scan.html?token=XYZ, just paste it — we will extract the token.
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Session Info</h5>
          <div id="sessionInfo" class="mb-3 text-muted">No token validated yet.</div>

          <div id="statusBadges" class="mb-3"></div>

          <form id="feedbackForm" class="d-none">
            <input type="hidden" id="tokenField" />

            <div class="mb-3">
              <label class="form-label">Clarity (1–5)</label>
              <input type="range" id="clarity" class="form-range" min="1" max="5" step="1" value="3" />
            </div>
            <div class="mb-3">
              <label class="form-label">Engagement (1–5)</label>
              <input type="range" id="engagement" class="form-range" min="1" max="5" step="1" value="4" />
            </div>
            <div class="mb-3">
              <label class="form-label">Pace (1–5)</label>
              <input type="range" id="pace" class="form-range" min="1" max="5" step="1" value="4" />
            </div>
            <div class="mb-3">
              <label class="form-label">Comments (optional)</label>
              <textarea id="comment" class="form-control" rows="3" placeholder="Your feedback..."></textarea>
            </div>

            <button type="submit" class="btn btn-success">Submit Feedback</button>
            <div id="submitNote" class="form-text mt-2"></div>
          </form>

          <div id="resultMsg" class="alert d-none mt-3" role="alert"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="/assets/js/common.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
  (async function () {
    try {
      await auth.requireAuth(['Student']);
    } catch { return; }

    document.getElementById('logoutBtn').addEventListener('click', auth.logout);

    const globalAlert = document.getElementById('globalAlert');
    function showGlobalAlert(msg, type = 'warning') {
      globalAlert.textContent = msg;
      globalAlert.className = 'alert alert-' + type;
      globalAlert.classList.remove('d-none');
    }
    function hideGlobalAlert() { globalAlert.classList.add('d-none'); }

    const sessionInfoEl = document.getElementById('sessionInfo');
    const statusBadgesEl = document.getElementById('statusBadges');
    const feedbackForm = document.getElementById('feedbackForm');
    const resultMsg = document.getElementById('resultMsg');
    const tokenField = document.getElementById('tokenField');

    function setSessionInfo(html) { sessionInfoEl.innerHTML = html; }
    function setBadges({ isOpen, isExpired, isEnrolled, alreadySubmitted, canSubmit, expiresAt }) {
      const parts = [];
      parts.push(`<span class="badge text-bg-${isOpen ? 'success' : 'secondary'} stat-badge me-1">${isOpen ? 'Open' : 'Closed'}</span>`);
      parts.push(`<span class="badge text-bg-${isExpired ? 'danger' : 'info'} stat-badge me-1">${isExpired ? 'Expired' : 'Valid'}</span>`);
      parts.push(`<span class="badge text-bg-${isEnrolled ? 'success' : 'warning'} stat-badge me-1">${isEnrolled ? 'Enrolled' : 'Not Enrolled'}</span>`);
      parts.push(`<span class="badge text-bg-${alreadySubmitted ? 'warning' : 'primary'} stat-badge me-1">${alreadySubmitted ? 'Submitted' : 'Not Submitted'}</span>`);
      if (expiresAt) parts.push(`<span class="badge text-bg-light stat-badge">Expires: ${new Date(expiresAt).toLocaleString()}</span>`);
      statusBadgesEl.innerHTML = parts.join(' ');
    }
    function showResult(msg, type = 'success') {
      resultMsg.textContent = msg;
      resultMsg.className = 'alert alert-' + type;
      resultMsg.classList.remove('d-none');
    }
    function hideResult() { resultMsg.classList.add('d-none'); }

    function extractToken(input) {
      const raw = (input || '').trim();
      if (!raw) return null;

      try {
        const url = new URL(raw);
        const t = url.searchParams.get('token');
        if (t) return t.trim();
        const seg = url.pathname.split('/').pop();
        if (/^[a-fA-F0-9]{16,64}$/.test(seg || '')) return seg;
      } catch {
      }

      const m = raw.match(/token=([a-fA-F0-9]{16,64})/i);
      if (m) return m[1];
      if (/^[a-fA-F0-9]{16,64}$/.test(raw)) return raw;

      return null;
    }

    async function validateToken(token) {
      hideGlobalAlert(); hideResult();
      setSessionInfo('Validating token...');
      statusBadgesEl.innerHTML = '';
      feedbackForm.classList.add('d-none');

      try {
        const res = await api.get(`/api/student/qr/${encodeURIComponent(token)}`);
        const d = res.data;

        tokenField.value = token;

        setSessionInfo(`
          <div>
            <div><b>Course:</b> ${d.courseCode} — ${d.courseTitle}</div>
            <div><b>Teacher:</b> ${d.teacherName || ''}</div>
            <div><b>Session ID:</b> ${d.sessionId}</div>
          </div>
        `);
        setBadges({
          isOpen: d.isOpen,
          isExpired: d.isExpired,
          isEnrolled: d.isEnrolled,
          alreadySubmitted: d.alreadySubmitted,
          canSubmit: d.canSubmit,
          expiresAt: d.qrExpiresAt
        });

        if (d.canSubmit) {
          feedbackForm.classList.remove('d-none');
          document.getElementById('submitNote').textContent = 'You can submit once for this session.';
        } else {
          feedbackForm.classList.add('d-none');
          if (!d.isOpen) showResult('Session is closed.', 'secondary');
          else if (d.isExpired) showResult('QR token expired.', 'warning');
          else if (!d.isEnrolled) showResult('You are not enrolled in this course.', 'warning');
          else if (d.alreadySubmitted) showResult('You have already submitted feedback for this session.', 'info');
          else showResult('You cannot submit at this time.', 'secondary');
        }
      } catch (err) {
        let msg = 'Invalid or unreachable token.';
        const s = err?.response?.status;
        if (s === 404) msg = 'Invalid QR token.';
        else if (s === 410) msg = 'QR token expired.';
        else if (s === 400) msg = err?.response?.data?.message || 'Session is closed.';
        else if (s === 403) msg = 'You are not enrolled in this course.';
        showGlobalAlert(msg, 'danger');
        setSessionInfo('No token validated.');
      }
    }

    document.getElementById('validateBtn').addEventListener('click', async () => {
      const raw = document.getElementById('manualToken').value;
      const token = extractToken(raw);
      if (!token) { showGlobalAlert('Please paste a valid token or URL containing ?token=...', 'warning'); return; }
      await validateToken(token);
    });

    document.getElementById('feedbackForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      hideResult();
      const payload = {
        token: tokenField.value,
        clarity: parseInt(document.getElementById('clarity').value, 10),
        engagement: parseInt(document.getElementById('engagement').value, 10),
        pace: parseInt(document.getElementById('pace').value, 10),
        comment: document.getElementById('comment').value
      };
      try {
        const res = await api.post('/api/student/feedback', payload);
        showResult('Feedback submitted. Thank you!', 'success');
        feedbackForm.classList.add('d-none');
      } catch (err) {
        const s = err?.response?.status;
        if (s === 409) showResult('Already submitted for this session.', 'info');
        else if (s === 410) showResult('QR token expired. Ask the teacher to regenerate.', 'warning');
        else if (s === 400) showResult(err?.response?.data?.message || 'Session closed.', 'secondary');
        else if (s === 403) showResult('You are not enrolled in this course.', 'warning');
        else showResult('Submission failed. Try again.', 'danger');
      }
    });

    const startBtn = document.getElementById('startScanBtn');
  const stopBtn = document.getElementById('stopScanBtn');
  const cameraSelect = document.getElementById('cameraSelect');

  let html5QrCode = null;
  let scanning = false;

  function pickBackCamera(devices){
    const back = devices.find(d => /back|rear|environment/i.test(d.label || ""));
    if (back) return back.id;
    return (devices[devices.length - 1] || {}).id;
  }

  async function populateCameras(){
    try {
      const devices = await Html5Qrcode.getCameras();
      cameraSelect.innerHTML = '';
      devices.forEach((d, idx) => {
        const opt = document.createElement('option');
        opt.value = d.id;
        opt.textContent = d.label || `Camera ${idx+1}`;
        cameraSelect.appendChild(opt);
      });
      const backId = pickBackCamera(devices);
      if (backId) cameraSelect.value = backId;
    } catch { }
  }

  async function startScanner(){
    if (scanning) return;
    const config = { fps: 10, qrbox: { width: 250, height: 250 } };
    if (!html5QrCode) html5QrCode = new Html5Qrcode('reader');

    try {
      const onScan = async (decodedText) => {
        const token = extractToken(decodedText);
        if (token) {
          await stopScanner();
          document.getElementById('manualToken').value = token;
          await validateToken(token);
        }
      };

      const chosenId = cameraSelect.value;
      if (chosenId) {
        await html5QrCode.start(chosenId, config, onScan);
      } else {
        await html5QrCode.start({ facingMode: { exact: "environment" } }, config, onScan);
      }

      scanning = true;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      await populateCameras();
    } catch (e) {
      showGlobalAlert('Unable to start camera. Use the manual token field or try a different browser.', 'danger');
      console.error(e);
    }
  }

  async function stopScanner(){
    if (!html5QrCode || !scanning) return;
    try { await html5QrCode.stop(); } catch {}
    try { html5QrCode.clear(); } catch {}
    scanning = false;
    startBtn.disabled = false;
    stopBtn.disabled = true;
  }

  startBtn.addEventListener('click', startScanner);
  stopBtn.addEventListener('click', stopScanner);

  await populateCameras();

  const urlToken = new URLSearchParams(location.search).get('token');
  if (urlToken) {
    document.getElementById('manualToken').value = urlToken;
    await validateToken(urlToken);
  }
  })();
</script>
</body>
</html>