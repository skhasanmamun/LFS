<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Teacher | Averages</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>.table-wrap{overflow-x:auto}.badge-stat{font-size:.9rem}</style>
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg bg-body-tertiary">
  <div class="container">
    <a class="navbar-brand" href="/dashboard.html">Lecture Feedback</a>
    <div class="d-flex">
      <a class="btn btn-outline-secondary btn-sm me-2" href="/dashboard.html">Dashboard</a>
      <button class="btn btn-outline-danger btn-sm" id="logoutBtn">Sign out</button>
    </div>
  </div>
</nav>

<div class="container py-4">
  <h4 class="mb-3">Teacher Averages</h4>
  <div id="pageAlert" class="alert d-none" role="alert"></div>

  <div class="card shadow-sm mb-3">
    <div class="card-body row g-3 align-items-end">
      <div class="col-md-4">
        <label class="form-label">From (UTC)</label>
        <input id="fromDate" type="datetime-local" class="form-control" />
      </div>
      <div class="col-md-4">
        <label class="form-label">To (UTC)</label>
        <input id="toDate" type="datetime-local" class="form-control" />
      </div>
      <div class="col-md-4 d-flex gap-2">
        <button id="apply" class="btn btn-primary flex-grow-1">Apply</button>
        <button id="clear" class="btn btn-outline-secondary">Clear</button>
      </div>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="card-title">My Courses (averages)</h5>
      <div class="table-wrap">
        <table class="table table-sm">
          <thead><tr>
            <th>Code</th><th>Title</th><th>Count</th>
            <th>Clarity</th><th>Engagement</th><th>Pace</th><th>Overall</th><th></th>
          </tr></thead>
          <tbody id="coursesBody"><tr><td colspan="8" class="text-center text-muted">No data</td></tr></tbody>
        </table>
      </div>

      <div id="courseDetail" class="mt-4 d-none">
        <h6 id="cdTitle">Course Sessions</h6>
        <div class="table-wrap">
          <table class="table table-sm">
            <thead><tr>
              <th>Session ID</th><th>Start</th><th>End</th><th>Open</th>
              <th>Count</th><th>Clarity</th><th>Engagement</th><th>Pace</th><th>Overall</th>
            </tr></thead>
            <tbody id="sessBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="/assets/js/common.js"></script>
<script>
  (async function(){
    try { await auth.requireAuth(['Teacher']); } catch { return; }
    document.getElementById('logoutBtn').addEventListener('click', auth.logout);

    const alertEl = document.getElementById('pageAlert');
    const showAlert = (m,t='info') => { alertEl.textContent=m; alertEl.className='alert alert-'+t; alertEl.classList.remove('d-none'); };
    const hideAlert = () => alertEl.classList.add('d-none');
    const coursesBody = document.getElementById('coursesBody');
    const fromDate = document.getElementById('fromDate'), toDate = document.getElementById('toDate');
    document.getElementById('apply').addEventListener('click', loadOverview);
    document.getElementById('clear').addEventListener('click', ()=>{ fromDate.value=''; toDate.value=''; loadOverview(); });

    function round2(n){ return Math.round((n + Number.EPSILON) * 100) / 100; }
    function fmt(d){ return d? new Date(d).toLocaleString() : ''; }

    async function loadOverview(){
      hideAlert();
      coursesBody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">Loading...</td></tr>`;
      const params = {};
      const f = fromDate.value ? new Date(fromDate.value).toISOString() : null;
      const t = toDate.value ? new Date(toDate.value).toISOString() : null;
      if (f) params.from=f; if (t) params.to=t;

      try {
        const res = await api.get('/api/teacher/reports/overview', { params });
        const items = res.data || [];
        if (!items.length) { coursesBody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">No data</td></tr>`; return; }
        coursesBody.innerHTML = items.map(c=>{
          const o = round2(c.stats.avgOverall);
          return `<tr>
            <td class="mono">${c.code}</td>
            <td>${c.title}</td>
            <td>${c.stats.count}</td>
            <td>${round2(c.stats.avgClarity)}</td>
            <td>${round2(c.stats.avgEngagement)}</td>
            <td>${round2(c.stats.avgPace)}</td>
            <td><span class="badge text-bg-${o>=4?'success':o>=3?'warning':'secondary'}">${o}</span></td>
            <td><button class="btn btn-sm btn-outline-primary" data-action="detail" data-id="${c.courseId}">Sessions</button></td>
          </tr>`;
        }).join('');
      } catch { showAlert('Failed to load','danger'); }
    }

    const cd = document.getElementById('courseDetail'), cdTitle = document.getElementById('cdTitle'), sessBody = document.getElementById('sessBody');
    coursesBody.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-action="detail"]'); if(!btn) return;
      const courseId = parseInt(btn.getAttribute('data-id'),10);
      await loadCourse(courseId);
    });

    async function loadCourse(courseId){
      const params = {};
      const f = fromDate.value ? new Date(fromDate.value).toISOString() : null;
      const t = toDate.value ? new Date(toDate.value).toISOString() : null;
      if (f) params.from=f; if (t) params.to=t;

      try {
        const res = await api.get(`/api/teacher/reports/course/${courseId}`, { params });
        const c = res.data;
        cd.classList.remove('d-none');
        cdTitle.textContent = `${c.code} â€” ${c.title}`;
        sessBody.innerHTML = c.sessions.map(s=>{
          const o = round2(s.stats.avgOverall);
          return `<tr>
            <td class="mono">${s.sessionId}</td>
            <td>${fmt(s.startTime)}</td>
            <td>${fmt(s.endTime) || '-'}</td>
            <td>${s.isOpen?'<span class="badge text-bg-success">Open</span>':'<span class="badge text-bg-secondary">Closed</span>'}</td>
            <td>${s.stats.count}</td>
            <td>${round2(s.stats.avgClarity)}</td>
            <td>${round2(s.stats.avgEngagement)}</td>
            <td>${round2(s.stats.avgPace)}</td>
            <td><span class="badge text-bg-${o>=4?'success':o>=3?'warning':'secondary'}">${o}</span></td>
          </tr>`;
        }).join('');
      } catch { showAlert('Failed to load sessions','danger'); }
    }

    await loadOverview();
  })();
</script>
</body>
</html>